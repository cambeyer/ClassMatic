<!doctype html>
<html>
	<head>
	<title>ClassMatic</title>
	<link rel="stylesheet" type="text/css" href="style.css">
	<link rel="stylesheet" type="text/css" href="http://fonts.googleapis.com/css?family=Roboto">
	<script src="http://code.jquery.com/jquery-2.1.3.min.js"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.3.0/angular.min.js"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.3.0/angular-animate.js"></script>
	<script src="./socket.io/socket.io.js"></script>
	<script type="text/javascript">
	
		angular.module('ClassMaticApp', ['ClassMaticApp.controllers', 'ClassMaticApp.directives', 'ClassMaticApp.factories', 'ngAnimate']);
		
		angular.module('ClassMaticApp.factories', [])
		.factory('RecursionHelper', ['$compile', function($compile){
			return {
				compile: function(element, link){
					if(angular.isFunction(link)){
						link = { post: link };
					}
					var contents = element.contents().remove();
					var compiledContents;
					return {
						pre: (link && link.pre) ? link.pre : null,
						post: function(scope, element){
							if(!compiledContents){
								compiledContents = $compile(contents);
							}
							compiledContents(scope, function(clone){
								element.append(clone);
							});
							if(link && link.post){
								link.post.apply(null, arguments);
							}
						}
					};
				}
			};
		}]);
		
		angular.module('ClassMaticApp.directives', []).
		directive('viewer', function ($location) {
			return {
				restrict: 'E',
				scope: false,
				replace: true,
				link: function (scope, element, attrs) {
					var link = $location.protocol() + "://" + $location.host() + ':' + $location.port() + '/download?active=' + attrs.active + '&hash=' + attrs.hash;
					element.html('<div style="background-color: #F8F8F8; border: 1px solid #D8D8D8; padding: 20px; text-align: center"><div style="padding: 0px; line-height: 0px; display: none">' +
					'<video controls preload = "auto" style="max-height: 500px; max-width: 500px" src="' + link + '" onerror="if ($(this).siblings().length == 1) { $(this).parent().css(\'display\', \'\'); } $(this).remove();" oncanplay="if (this.duration > 0) { $(this).siblings().remove(); $(this).parent().css(\'display\', \'\'); } else { if ($(this).siblings().length == 1) { $(this).parent().css(\'display\', \'\'); } $(this).remove(); }"></video>' + 
					'<img style="max-height: 400px; max-width: 400px" src="' + link + '" onerror="if ($(this).siblings().length == 1) { $(this).parent().css(\'display\', \'\'); } $(this).remove();" onload="$(this).siblings().remove(); $(this).parent().css(\'display\', \'\')">' + 
					'<iframe src="https://docs.google.com/gview?url=' + encodeURIComponent(link) + '&embedded=true" style="width:600px; height:500px;" frameborder="0" onload="if ($(this).siblings().length == 0) { $(this).parent().css(\'display\', \'\'); }"></iframe>' +
					'</div></div>');
				}
			};
		}).
		directive('dragAndDrop', function($rootScope) {
			return {
				scope: false,
				restrict: 'A',
				link: function($scope, elem, attr) {
					elem.bind('dragenter', function(e) {
						e.stopPropagation();
						e.preventDefault();
						if ($scope.path) {
							elem.css('background-color', '#66C166');
						}
					});
					elem.bind('dragleave', function(e) {
						e.stopPropagation();
						e.preventDefault();
						if ($scope.path) {
							elem.css('background-color', '#F1F1F1');
						}
					});
					elem.bind('dragover', function(e) {
						e.stopPropagation();
						e.preventDefault();
						if ($scope.path) {
							elem.css('background-color', '#66C166');
						}
					});
					elem.bind('drop', function(e) {
						e.stopPropagation();
						e.preventDefault();
						if ($scope.path) {
							elem.css('background-color', '#F1F1F1');
						}
						var go = true;
						if ($rootScope.fields.droppedFiles.length > 0) {
							go = confirm("This will overwrite your previously dropped files.");
						} 
						if (go) {
							$rootScope.$apply(function () {
								$rootScope.fields.droppedFiles = e.originalEvent.dataTransfer.files; //no originalEvent if jQuery script is included after angular
								if ($rootScope.fields.droppedFiles.length > 0) {
									$rootScope.fields.custom = "yes";
									$rootScope.fields.upload = true;
									if ($scope.path && $scope.path !== "") {
										$rootScope.fields.folderName = $scope.path.substring(0, $scope.path.length - 1);
									} else {
										$rootScope.fields.folderName = "/";
									}
								}
							});	
						}
					});
				}
			};
		}).
		directive('specialForm', function($rootScope) {
			return {
				scope: false,
				restrict: 'A',
				link: function($scope, elem, attr) {
					elem.bind('submit', function(e) {
						e.preventDefault();
						oData = new FormData(document.forms.namedItem("uploadform"));
						for (var i = 0; i < $rootScope.fields.droppedFiles.length; i++) 
						{
							oData.append($scope.activeClass, $rootScope.fields.droppedFiles[i]);
						}
						var oReq = new XMLHttpRequest();
						oReq.open("post", "upload", true);
						oReq.onload = function(oEvent) {
							if (oReq.status == 200) {
								try {
									$rootScope.$apply(function () {
										$rootScope.fields.droppedFiles = [];
										$rootScope.fields.folderName = "/";
									});	
									document.getElementById('title').value = '';
									document.getElementById('file').value = '';
								} catch (e) {}
							} else {
								alert("There was an error uploading your file");
							}
						};
						oReq.send(oData);
					});
				}
			};
		}).
		directive('folder', function(RecursionHelper) {
			return {
				scope: false,
				restrict: 'E',
				template: '' + 
					'<ul class="example-animate-container">' + 
						'<li class="animate-repeat" ng-repeat="file in object.files | orderBy: \'-date\' track by file.hash" ng-if="currentDate >= file.reveal">' + 
							'<b>{{file.title}}</b> - <a ng-href="download?active={{activeClass}}&hash={{path + file.hash}}" ng-bind="file.name"></a> (<a href="#" ng-click="preview[path + file.hash] = !preview[path + file.hash]">{{preview[path + file.hash] ? "close" : "preview"}}</a>, <a ng-href="delete?active={{activeClass}}&hash={{path + file.hash}}" target="hidden-iframe">delete</a>) - uploaded {{file.date | date:"M/dd/yy \'at\' h:mma"}}<br />' + 
							'<viewer ng-if="preview[path + file.hash]" hash="{{path + file.hash}}" active="{{activeClass}}"></viewer>' + 
						'</li>' + 
						'<li ng-class="divClass" class="animate-repeat" ng-repeat="(name, folder) in object.folders" ng-if="folder.files || folder.folders">' + 
							'<div class="noselect" style="padding-left: 20px">' + 
								'<p></p>' + 
								'<div drag-and-drop style="background-color: #F1F1F1; padding: 5px; border: solid 1px #909090" ng-click="foldershow = !foldershow"><img src="folder.png" style="max-height: 35px; padding-top: 5px; padding-right: 5px; padding-left: 10px"> <span style="vertical-align: top">{{name}}</span><img ng-src="{{foldershow ? \'expand.png\' : \'collapse.png\'}}" style="max-height: 35px; float: right; padding-top: 5px"></div>' + 
								'<folder ng-show="!foldershow" data="folder" path="name"></folder>' + 
							'</div>' + 
						'</li>' + 
					'</ul>',
				compile: function(element) {
					return RecursionHelper.compile(element, function(scope, iElement, iAttrs, controller, transcludeFn){
						scope.$watch(iAttrs.data, function (value){
							if (value) {
								scope.object = value;
							}
						});
						scope.$watch(iAttrs.path, function (value){
							if (value && scope.path !== undefined) {
								scope.path += value + "/";
							} else {
								scope.path = "";
							}
						});
					});
				}
			};
		});

		angular.module('ClassMaticApp.controllers', []).controller('mainController', function($scope, $rootScope, $interval) {
			
			$rootScope.fields = {
				upload: false,
				droppedFiles: [],
				folderName: "/",
				custom: "no"
			}
			
			$scope.files = {};
			$scope.currentDate = Date.now();
			$interval(function() {
				$scope.currentDate = Date.now();
			}, 1000);
			$scope.classes = ['MCS1', 'MCS2', 'MCS3'];
			$scope.activeClass = $scope.classes[0];
			$scope.socket = io();
			$scope.socket.on('reconnect', function(num) {
				$scope.requestFiles();
			});
			$scope.requestFiles = function() {
				$scope.socket.emit('message', $scope.activeClass);
			}
			$scope.socket.on('message', function (msg){
				$scope.$apply(function () {
					for (var className in msg) {
						if ($scope.files[className] || $scope.activeClass == className) {
							$scope.files[className] = msg[className];
							if (!$scope.files[$scope.activeClass] || !$scope.files[$scope.activeClass].folders) {
								$rootScope.fields.custom = "yes";
							}
						}
					}
				});	
			});
		});
	</script>
	<style type="text/css">
		body { font-family: 'Roboto', serif; }
	</style>
</head>
<body ng-app="ClassMaticApp" style="background-color: #F8F8F8">
	<div ng-controller="mainController" style="height: 100%" drag-and-drop>
		<iframe name="hidden-iframe" style="display: none;" onLoad="try { document.getElementById('title').value = ''; document.getElementById('file').value = ''; document.getElementById('folder').value = '' } catch (e) {}"></iframe>
		<a href="http://www.ltu.edu"><img ng-src="ltu.png" style="max-height: 50px; position: absolute; top: 10px; left: 15px"></a>
		<img ng-src="{{!fields.upload ? 'expand.png' : 'collapse.png'}}" style="max-height: 35px; position: absolute; right: 10px; top: 15px" ng-click="fields.upload = !fields.upload">
		<div class="noselect" style="height: 60px; text-align: center; background-color: #66C166; padding: 5px; border-bottom: solid 1px #909090" ng-click="fields.upload = !fields.upload"><h2 style="padding-top: 15px; margin-top: 0px; color: white">Upload Here</h2></div>
		<div style="text-align: center">
			<div style="text-align: left; width: 100%; background-color: #C1E6C1; padding-top: 20px" ng-show="fields.upload">
				<form name="uploadform" special-form>
					<table style="padding: 20px; border: 1px solid #909090" cellpadding="10" cellspacing="0" border="0" align="center">
						<tr>
							<td>Title:</td>
							<td>
								<input style="width: 200px" id="title" type="text" name='title' autocomplete="off" ng-required="true">
							</td>
						</tr>
						<tr>
							<td valign="top">Choose:</td>
							<td>
								<!--ng-model is used with the values to select radio buttons-->
								<input type="radio" ng-disabled="!files[activeClass].folders" name="customfolder" value="no" ng-model="fields.custom">Choose Existing Folder<br />
								<input type="radio" name="customfolder" value="yes" ng-model="fields.custom">Create New Folder
							</td>
						</tr>
						<tr>
							<td>Folder:</td>
							<td>
								<!--must have an ng-model to make this work-->
								<select ng-if="fields.custom == 'no'" ng-model="folder" ng-options="folder as folder for (folder, object) in files[activeClass].folders" name='folder' ng-required="true">
									<option value="" ng-if="false"></option>
								</select>
								<!--id of folder so when the special form submits it can be reset-->
								<input ng-if="fields.custom == 'yes'" id="folder" ng-model="fields.folderName" type="text" name='folder' ng-required="true" autocomplete="off">
							</td>
						</tr>
						<tr>
							<td>File:</td>
							<td>
								<input style="width: 200px" id="file" type='file' name='{{activeClass}}' ng-show="!(fields.droppedFiles.length > 0)" ng-required="!(fields.droppedFiles.length > 0)" multiple="multiple">
								<span ng-show="fields.droppedFiles.length" style="color: red"><b>{{fields.droppedFiles.length}} selected</b> <img style="float: right; max-height: 20px" ng-src="x.png" ng-click="fields.droppedFiles = []"></span>
							</td>
						</tr>
						<tr>
							<td colspan="2" align="center" style="padding-top: 40px">
								<input type='hidden' name='reveal' value='{{currentDate - 1000}}'></input>
								<input style="width: 80%; height: 50px" type='submit' value='Submit'></input>
							</td>
						</tr>
					</table>
				</form>
			</div>
			<div ng-show="fields.upload" style="width: 100%; border-bottom: 1px solid #909090; padding-top: 20px; background-color: #C1E6C1"></div>
			<div style="display: inline-block; text-align: left; width: 100%; max-width: 800px">
				<div style="padding-top: 40px; padding-bottom: 40px">
					<span style="padding-right: 10px">Class: </span><select ng-options="class for class in classes" ng-change="foldershow = []; requestFiles()" ng-init="requestFiles()" ng-model="activeClass"></select>
				</div>
				<folder data='files[activeClass]'></folder>
			</div>
		</div>
	</div>
</body>
</html>